DO
$$
DECLARE
    r RECORD;
    _uid INTEGER;
    athlete_pk TEXT;
    coach_pk TEXT;
BEGIN

    -- ===== Ensure users table exists =====
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables WHERE table_name = 'users'
    ) THEN
        CREATE TABLE users (
            id SERIAL PRIMARY KEY,
            username VARCHAR(100) NOT NULL UNIQUE,
            password VARCHAR(255),
            email VARCHAR(255) UNIQUE,
            created_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        RAISE NOTICE 'Created table: users';
    END IF;

    -- ===== Ensure roles table exists =====
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.tables WHERE table_name = 'roles'
    ) THEN
        CREATE TABLE roles (
            id SERIAL PRIMARY KEY,
            name VARCHAR(50) NOT NULL,
            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE
        );
        RAISE NOTICE 'Created table: roles';
    END IF;

    -- ===== Add user_id column if missing =====
    BEGIN
        ALTER TABLE athletes ADD COLUMN IF NOT EXISTS user_id INTEGER REFERENCES users(id) ON DELETE SET NULL;
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;

    BEGIN
        ALTER TABLE coaches ADD COLUMN IF NOT EXISTS user_id INTEGER REFERENCES users(id) ON DELETE SET NULL;
    EXCEPTION WHEN duplicate_column THEN
        NULL;
    END;

    -- ===== Detect primary keys dynamically =====
    SELECT kcu.column_name
    INTO athlete_pk
    FROM information_schema.table_constraints tc
    JOIN information_schema.key_column_usage kcu
      ON tc.constraint_name = kcu.constraint_name
     AND tc.table_name = kcu.table_name
    WHERE tc.table_name = 'athletes' AND tc.constraint_type = 'PRIMARY KEY'
    LIMIT 1;

    SELECT kcu.column_name
    INTO coach_pk
    FROM information_schema.table_constraints tc
    JOIN information_schema.key_column_usage kcu
      ON tc.constraint_name = kcu.constraint_name
     AND tc.table_name = kcu.table_name
    WHERE tc.table_name = 'coaches' AND tc.constraint_type = 'PRIMARY KEY'
    LIMIT 1;

    RAISE NOTICE 'Detected athlete PK: %', athlete_pk;
    RAISE NOTICE 'Detected coach PK: %', coach_pk;

    -- ===== Create users for athletes =====
    FOR r IN EXECUTE format('SELECT %I AS pk, name FROM athletes WHERE user_id IS NULL', athlete_pk)
    LOOP
        INSERT INTO users (username, password, email)
        VALUES (LOWER(REPLACE(r.name, ' ', '_')), NULL, NULL)
        RETURNING id INTO _uid;

        EXECUTE format('UPDATE athletes SET user_id = %s WHERE %I = %L', _uid, athlete_pk, r.pk);

        INSERT INTO roles (name, user_id) VALUES ('athlete', _uid);

        RAISE NOTICE 'Added athlete user for % (athlete PK=%)', r.name, r.pk;
    END LOOP;

    -- ===== Create users for coaches =====
    FOR r IN EXECUTE format('SELECT %I AS pk, name FROM coaches WHERE user_id IS NULL', coach_pk)
    LOOP
        INSERT INTO users (username, password, email)
        VALUES (LOWER(REPLACE(r.name, ' ', '_')), NULL, NULL)
        RETURNING id INTO _uid;

        EXECUTE format('UPDATE coaches SET user_id = %s WHERE %I = %L', _uid, coach_pk, r.pk);

        INSERT INTO roles (name, user_id) VALUES ('coach', _uid);

        RAISE NOTICE 'Added coach user for % (coach PK=%)', r.name, r.pk;
    END LOOP;

    RAISE NOTICE ' User and Role linking complete!';

END;
$$;
