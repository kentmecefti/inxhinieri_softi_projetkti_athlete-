<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">athlete-results-pg</a> &gt; <a href="index.source.html" class="el_package">com.example.athleteresults.controllers</a> &gt; <span class="el_source">PlanController.java</span></div><h1>PlanController.java</h1><pre class="source lang-java linenums">package com.example.athleteresults.controllers;

import com.example.athleteresults.entities.Plan;
import com.example.athleteresults.entities.Athlete;
import com.example.athleteresults.entities.Coach;
import com.example.athleteresults.entities.Result;
import com.example.athleteresults.repositories.PlanRepository;
import com.example.athleteresults.services.PlanService;
import com.example.athleteresults.repositories.AthleteRepository;
import com.example.athleteresults.repositories.CoachRepository;
import jakarta.persistence.criteria.Predicate;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.List;

@RestController
@RequestMapping(&quot;/api/plans&quot;)
@CrossOrigin(origins = &quot;*&quot;)
public class PlanController {

    private final PlanService planService;
    private final AthleteRepository athleteRepository;
    private final CoachRepository coachRepository;
    private final PlanRepository repo;

<span class="nc" id="L30">    public PlanController(PlanService planService, AthleteRepository athleteRepository, CoachRepository coachRepository, PlanRepository repo) {</span>
<span class="nc" id="L31">        this.planService = planService;</span>
<span class="nc" id="L32">        this.athleteRepository = athleteRepository;</span>
<span class="nc" id="L33">        this.coachRepository = coachRepository;</span>
<span class="nc" id="L34">        this.repo = repo;</span>
<span class="nc" id="L35">    }</span>

    // ====== GET all plans ======
    @GetMapping
    public List&lt;PlanDTO&gt; getAllPlans() {
<span class="nc" id="L40">        return planService.getAllPlans().stream()</span>
<span class="nc" id="L41">                .map(PlanDTO::fromEntity)</span>
<span class="nc" id="L42">                .toList();</span>
    }

    // ====== GET by ID ======
    @GetMapping(&quot;/{id}&quot;)
    public PlanDTO getPlanById(@PathVariable Integer id) {
<span class="nc" id="L48">        Plan plan = planService.getPlanById(id)</span>
<span class="nc" id="L49">                .orElseThrow(() -&gt; new RuntimeException(&quot;Plan not found with id &quot; + id));</span>
<span class="nc" id="L50">        return PlanDTO.fromEntity(plan);</span>
    }

    // ====== GET by Athlete ======
    @GetMapping(&quot;/athlete/{athleteId}&quot;)
    public List&lt;PlanDTO&gt; getPlansByAthlete(@PathVariable Integer athleteId) {
<span class="nc" id="L56">        return planService.getPlansByAthlete(athleteId).stream()</span>
<span class="nc" id="L57">                .map(PlanDTO::fromEntity)</span>
<span class="nc" id="L58">                .toList();</span>
    }

    // ====== GET by Coach ======
    @GetMapping(&quot;/coach/{coachId}&quot;)
    public List&lt;PlanDTO&gt; getPlansByCoach(@PathVariable Integer coachId) {
<span class="nc" id="L64">        return planService.getPlansByCoach(coachId).stream()</span>
<span class="nc" id="L65">                .map(PlanDTO::fromEntity)</span>
<span class="nc" id="L66">                .toList();</span>
    }

    // ====== CREATE ======
    @PostMapping
    public PlanDTO createPlan(@RequestBody PlanRequest req) {
<span class="nc" id="L72">        Athlete athlete = athleteRepository.findById(req.athleteId())</span>
<span class="nc" id="L73">                .orElseThrow(() -&gt; new RuntimeException(&quot;Athlete not found&quot;));</span>
<span class="nc" id="L74">        Coach coach = null;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (req.coachId() != null) {</span>
<span class="nc" id="L76">            coach = coachRepository.findById(req.coachId())</span>
<span class="nc" id="L77">                    .orElseThrow(() -&gt; new RuntimeException(&quot;Coach not found&quot;));</span>
        }


<span class="nc" id="L81">        Plan plan = new Plan();</span>
<span class="nc" id="L82">        plan.setAthlete(athlete);</span>
<span class="nc" id="L83">        plan.setCoach(coach);</span>
<span class="nc" id="L84">        plan.setPlanDate(req.planDate());</span>
<span class="nc" id="L85">        plan.setPredictionPlan(req.predictionPlan());</span>
<span class="nc" id="L86">        plan.setActualPlan(req.actualPlan());</span>
<span class="nc" id="L87">        plan.setNotes(req.notes());</span>

<span class="nc" id="L89">        return PlanDTO.fromEntity(planService.savePlan(plan));</span>
    }

    // ====== UPDATE ======
    @PutMapping(&quot;/{id}&quot;)
    public PlanDTO updatePlan(@PathVariable Integer id, @RequestBody PlanRequest req) {
<span class="nc" id="L95">        Plan existing = planService.getPlanById(id)</span>
<span class="nc" id="L96">                .orElseThrow(() -&gt; new RuntimeException(&quot;Plan not found with id &quot; + id));</span>

<span class="nc" id="L98">        Athlete athlete = athleteRepository.findById(req.athleteId())</span>
<span class="nc" id="L99">                .orElseThrow(() -&gt; new RuntimeException(&quot;Athlete not found&quot;));</span>
<span class="nc" id="L100">        Coach coach = null;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (req.coachId() != null) {</span>
<span class="nc" id="L102">            coach = coachRepository.findById(req.coachId())</span>
<span class="nc" id="L103">                    .orElseThrow(() -&gt; new RuntimeException(&quot;Coach not found&quot;));</span>
        }

<span class="nc" id="L106">        existing.setAthlete(athlete);</span>
<span class="nc" id="L107">        existing.setCoach(coach);</span>
<span class="nc" id="L108">        existing.setPlanDate(req.planDate());</span>
<span class="nc" id="L109">        existing.setPredictionPlan(req.predictionPlan());</span>
<span class="nc" id="L110">        existing.setActualPlan(req.actualPlan());</span>
<span class="nc" id="L111">        existing.setNotes(req.notes());</span>

<span class="nc" id="L113">        return PlanDTO.fromEntity(planService.savePlan(existing));</span>
    }

    // ====== DELETE ======
    @DeleteMapping(&quot;/{id}&quot;)
    public void deletePlan(@PathVariable Integer id) {
<span class="nc" id="L119">        planService.deletePlan(id);</span>
<span class="nc" id="L120">    }</span>

    // ====== SEND TO MULTIPLE ======
    @PostMapping(&quot;/coach/{coachId}/send&quot;)
    public List&lt;PlanDTO&gt; sendPlanToAthletes(
            @PathVariable Integer coachId,
            @RequestBody SendPlanRequest req) {

<span class="nc" id="L128">        Coach coach = coachRepository.findById(coachId)</span>
<span class="nc" id="L129">                .orElseThrow(() -&gt; new RuntimeException(&quot;Coach not found&quot;));</span>

<span class="nc" id="L131">        List&lt;Athlete&gt; athletes = athleteRepository.findAllById(req.athleteIds());</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (athletes.isEmpty()) {</span>
<span class="nc" id="L133">            throw new RuntimeException(&quot;No valid athletes found&quot;);</span>
        }

<span class="nc" id="L136">        return athletes.stream().map(athlete -&gt; {</span>
<span class="nc" id="L137">            Plan p = new Plan();</span>
<span class="nc" id="L138">            p.setCoach(coach);</span>
<span class="nc" id="L139">            p.setAthlete(athlete);</span>
<span class="nc" id="L140">            p.setPlanDate(req.planDate());</span>
<span class="nc" id="L141">            p.setPredictionPlan(req.predictionPlan());</span>
<span class="nc" id="L142">            p.setActualPlan(req.actualPlan());</span>
<span class="nc" id="L143">            p.setNotes(req.notes());</span>
<span class="nc" id="L144">            return PlanDTO.fromEntity(planService.savePlan(p));</span>
<span class="nc" id="L145">        }).toList();</span>
    }

    @GetMapping(&quot;/filter&quot;)
    public List&lt;PlanDTO&gt; filterResults(
            @RequestParam(required = false) Integer athleteId,
            @RequestParam(required = false) Integer coachId,
            @RequestParam(required = false)
            @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate from,
            @RequestParam(required = false)
            @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate to
    ) {
<span class="nc" id="L157">        Sort sort = Sort.by(&quot;planDate&quot;).ascending();</span>
<span class="nc" id="L158">        return repo.findAll(buildSpec(athleteId, coachId, from, to), sort)</span>
<span class="nc" id="L159">                .stream()</span>
<span class="nc" id="L160">                .map(PlanDTO::fromEntity)</span>
<span class="nc" id="L161">                .toList();</span>
    }

    // add inside PlanController
    @PatchMapping(&quot;/{id}/actual&quot;)
    public PlanDTO patchActual(@PathVariable Integer id, @RequestBody ActualOnly body) {
<span class="nc" id="L167">        Plan p = planService.getPlanById(id)</span>
<span class="nc" id="L168">                .orElseThrow(() -&gt; new RuntimeException(&quot;Plan not found with id &quot; + id));</span>
<span class="nc" id="L169">        p.setActualPlan(body.actualPlan());</span>
<span class="nc" id="L170">        return PlanDTO.fromEntity(planService.savePlan(p));</span>
    }

    // record for request body
<span class="fc" id="L174">    public record ActualOnly(String actualPlan) {}</span>


    // ===== Helper â€” dynamic Specification builder =====
    private Specification&lt;Plan&gt; buildSpec(
            Integer athleteId, Integer coachId, LocalDate from, LocalDate to
    ) {
<span class="nc" id="L181">        return (root, query, cb) -&gt; {</span>
<span class="nc" id="L182">            Predicate p = cb.conjunction();</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (athleteId != null)</span>
<span class="nc" id="L185">                p = cb.and(p, cb.equal(root.get(&quot;athlete&quot;).get(&quot;id&quot;), athleteId));</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (coachId != null)</span>
<span class="nc" id="L188">                p = cb.and(p, cb.equal(root.get(&quot;coach&quot;).get(&quot;id&quot;), coachId));</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (from != null)</span>
<span class="nc" id="L191">                p = cb.and(p, cb.greaterThanOrEqualTo(root.get(&quot;planDate&quot;), from));</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (to != null)</span>
<span class="nc" id="L194">                p = cb.and(p, cb.lessThan(root.get(&quot;planDate&quot;), to.plusDays(1)));</span>

<span class="nc" id="L196">            return p;</span>
        };
    }


    // ====== RECORD TYPES ======
<span class="fc" id="L202">    public record PlanRequest(</span>
            Integer athleteId,
            Integer coachId,
            java.time.LocalDate planDate,
            String predictionPlan,
            String actualPlan,
            String notes
    ) {}

<span class="fc" id="L211">    public record SendPlanRequest(</span>
            List&lt;Integer&gt; athleteIds,
            java.time.LocalDate planDate,
            String predictionPlan,
            String actualPlan,
            String notes
    ) {}

    // ====== DTO (Data Transfer Object) ======
<span class="fc" id="L220">    public record PlanDTO(</span>
            Integer id,
            java.time.LocalDate planDate,
            String predictionPlan,
            String actualPlan,
            String notes,
            String athleteName,
            String coachName,
            Integer athleteId,
            Integer coachId
    ) {
        public static PlanDTO fromEntity(Plan p) {
<span class="fc" id="L232">            return new PlanDTO(</span>
<span class="fc" id="L233">                    p.getId(),</span>
<span class="fc" id="L234">                    p.getPlanDate(),</span>
<span class="fc" id="L235">                    p.getPredictionPlan(),</span>
<span class="fc" id="L236">                    p.getActualPlan(),</span>
<span class="fc" id="L237">                    p.getNotes(),</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                    p.getAthlete() != null ? p.getAthlete().getName() : null,</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">                    p.getCoach() != null ? p.getCoach().getName() : null,</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                    p.getAthlete() != null ? p.getAthlete().getId() : null,</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                    p.getCoach() != null ? p.getCoach().getId() : null</span>
            );
        }
    }

    // ====== EXCEPTION HANDLER ======
    @ExceptionHandler(RuntimeException.class)
    @ResponseStatus(org.springframework.http.HttpStatus.BAD_REQUEST)
    public String handleRuntime(RuntimeException ex) {
<span class="nc" id="L250">        return ex.getMessage();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>